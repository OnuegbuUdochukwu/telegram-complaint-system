# Complaint Data Schema: Core `complaints` Table (Proposed)

Purpose: Define the structure and constraints for the primary complaint record. This document is a reviewable blueprint for the PostgreSQL table to be created in Phase 2 and for the Telegram bot's Phase 1 data collection.

NOTE: This file is a proposal. Two SQL variants are provided (UUID primary key and SERIAL primary key). Please review and approve or request changes before I finalize or generate migration files.

---

## 1. Table: `complaints`

The `complaints` table holds each student's maintenance request and metadata required for routing and status tracking.

| Field name         |                          Type (Postgres) | Constraint / Notes                                                                                                                                   | Source (Telegram step)                             |
| ------------------ | ---------------------------------------: | ---------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------- |
| id                 | UUID (preferred) or SERIAL (alternative) | Primary Key. Preferred: UUID generated by backend (e.g., gen_random_uuid() or uuid_generate_v4()). Alternative: SERIAL integer for smaller installs. | Backend generation                                 |
| telegram_user_id   |                              VARCHAR(32) | Not null. Telegram user id as string. Candidate FK to `users` table (future).                                                                        | Telegram context                                   |
| hostel             |                              VARCHAR(50) | Not null. Hostels should use canonical names (e.g., `Joseph Hall`). Consider a foreign-key to a `hostels` lookup in Phase 2.                         | Selection (inline keyboard)                        |
| wing               |                              VARCHAR(20) | Not null. e.g., `A`, `B`, `New Wing`. Consider normalization later.                                                                                  | Selection (inline keyboard)                        |
| room_number        |                              VARCHAR(10) | Not null. Alphanumeric (example: `A312`). Validate pattern in bot (regex) before insert.                                                             | Text input (validated)                             |
| category           |                              VARCHAR(50) | Not null. Must be one of the enumerated category values in section 2. Stored as compact keys (e.g., `plumbing`).                                     | Selection (inline keyboard)                        |
| photo_urls         |                                   TEXT[] | Nullable. Array of URLs (or paths) to uploaded photos. Store as text array; validate URLs at upload time.                                            | Optional (file/photo upload)                       |
| description        |                                     TEXT | Not null. Minimum length 10, maximum 500 characters (validate in bot).                                                                               | Text input                                         |
| severity           |                              VARCHAR(20) | Not null. Must be one of enumerated severity values (Low/Medium/High).                                                                               | Selection (inline keyboard)                        |
| status             |                              VARCHAR(20) | Not null. Default `'Reported'`. Must be one of enumerated status values in section 2.                                                                | Default / backend update                           |
| assigned_porter_id |                              VARCHAR(32) | Nullable. ID of assigned porter (if applicable).                                                                                                     | Dashboard update                                   |
| created_at         |                              TIMESTAMPTZ | Not null. Default: now() at insert; record submission time.                                                                                          | Backend generation (from bot submission timestamp) |
| updated_at         |                              TIMESTAMPTZ | Nullable. Updated on status/field change; backend to update.                                                                                         | Backend update                                     |

### Recommended indexes & constraints (Phase 2)

-   Primary Key on `id`.
-   Index on `telegram_user_id` (lookup by user).
-   Index on `status` (fast status queries and dashboard filters).
-   Index on `created_at` for recent complaints listing.
-   Consider foreign keys later for `hostel`, `category` if normalized lookup tables are introduced.

---

## 2. Permissible Enumerated Values

These lists will be used to populate inline keyboards in Phase 1 and to constrain/validate values at the application or DB level in Phase 2.

### Complaint Category (Telegram selection)

-   Plumbing / Water
-   Electrical / Lighting
-   Structural / Furniture
-   Pest Control
-   Common Area / Facility
-   Other / Not Listed

Recommendation: store compact storage keys in the DB and use human-friendly labels in the UI. Example mapping (display label -> storage key):

| Display Label          | Storage Key |
| ---------------------- | ----------- |
| Plumbing / Water       | plumbing    |
| Electrical / Lighting  | electrical  |
| Structural / Furniture | structural  |
| Pest Control           | pest        |
| Common Area / Facility | common_area |
| Other / Not Listed     | other       |

### Complaint Severity (Telegram selection)

-   Low
-   Medium
-   High

### Complaint Status (managed via dashboard)

-   Reported
-   In Progress
-   On Hold
-   Resolved
-   Rejected

Default status for a new complaint: `Reported`

---

## 3. Validation rules (Bot-level; to enforce before DB insert)

-   `telegram_user_id`: must be present and match Telegram numeric ID string (digits only), but allow up to 32 chars to be safe.
-   `hostel`: must match one of the allowed hostel labels supplied by the bot's inline keyboard.
-   `wing`: must match one of the wing options.
-   `room_number`: regex: allow alphanumeric, optional dash/space; proposed pattern: `^[A-Za-z0-9\-\s]{1,10}$`.
-   `category`: must be one of the category enums.
-   `description`: min length 10, max length 500.
-   `severity`: must be one of the severity enums.

Enforce these validations in the bot (Phase 1). Database constraints may duplicate some checks (e.g., NOT NULL, CHECK for length) in Phase 2.

---

## 4. Example JSON Schema (for payload validation)

Below is a proposed JSON Schema you can use server-side or for unit tests in Phase 1/2.

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Complaint",
    "type": "object",
    "required": [
        "telegram_user_id",
        "hostel",
        "wing",
        "room_number",
        "category",
        "description",
        "severity"
    ],
    "properties": {
        "telegram_user_id": { "type": "string", "pattern": "^[0-9]{3,32}$" },
        "hostel": { "type": "string", "maxLength": 50 },
        "wing": { "type": "string", "maxLength": 20 },
        "room_number": {
            "type": "string",
            "maxLength": 10,
            "pattern": "^[A-Za-z0-9\\-\\s]{1,10}$",
            "examples": ["A312"]
        },
        "category": {
            "type": "string",
            "enum": [
                "plumbing",
                "electrical",
                "structural",
                "pest",
                "common_area",
                "other"
            ]
        },
        "description": { "type": "string", "minLength": 10, "maxLength": 500 },
        "severity": { "type": "string", "enum": ["Low", "Medium", "High"] },
        "status": {
            "type": "string",
            "enum": [
                "reported",
                "in_progress",
                "on_hold",
                "resolved",
                "rejected"
            ]
        },
        "photo_urls": {
            "type": "array",
            "items": { "type": "string", "format": "uri" }
        }
    }
}
```

---

## 5. Two example SQL CREATE TABLE variants (pick one after review)

Variant A — UUID primary key (preferred for distributed systems)

```sql
-- Requires extension pgcrypto or uuid-ossp depending on chosen generator
CREATE EXTENSION IF NOT EXISTS pgcrypto; -- for gen_random_uuid()

CREATE TABLE complaints (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  telegram_user_id VARCHAR(32) NOT NULL,
  hostel VARCHAR(50) NOT NULL,
  wing VARCHAR(20) NOT NULL,
  room_number VARCHAR(10) NOT NULL,
  category VARCHAR(50) NOT NULL,
  description TEXT NOT NULL,
  photo_urls TEXT[],
  severity VARCHAR(20) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'reported',
  assigned_porter_id VARCHAR(32),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ
);

CREATE INDEX ON complaints (telegram_user_id);
CREATE INDEX ON complaints (status);
CREATE INDEX ON complaints (created_at);
```

Variant B — SERIAL integer primary key (simpler)

```sql
CREATE TABLE complaints (
  id SERIAL PRIMARY KEY,
  telegram_user_id VARCHAR(32) NOT NULL,
  hostel VARCHAR(50) NOT NULL,
  wing VARCHAR(20) NOT NULL,
  room_number VARCHAR(10) NOT NULL,
  category VARCHAR(50) NOT NULL,
  photo_urls TEXT[],
  description TEXT NOT NULL,
  severity VARCHAR(20) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'reported',
  assigned_porter_id VARCHAR(32),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ
);

CREATE INDEX ON complaints (telegram_user_id);
CREATE INDEX ON complaints (status);
CREATE INDEX ON complaints (created_at);
```

Notes: UUID keys are recommended when you need globally unique IDs, easier merging across systems, and less guessable public IDs. SERIAL is simpler for small projects and human-friendly numeric IDs.

---

## 6. Decisions / Items for your review (I will pause here)

1. Primary key choice: UUID (Variant A) or SERIAL (Variant B)?
2. Do you want storage values for `category`/`status` to be compact keys (e.g., `plumbing`) instead of human labels? If yes, I will add a mapping table and change the enums.
3. Any additional fields required now (e.g., photo URLs, reporter phone/email)?
4. Confirm `room_number` validation pattern or provide examples that the bot should accept/reject.

When you approve (or request changes), I'll:

-   Update this document if required.
-   Generate the final SQL migration for the chosen variant (Phase 2 migration-ready SQL).
-   Optionally wire the bot's `context.user_data` keys to match this schema.
