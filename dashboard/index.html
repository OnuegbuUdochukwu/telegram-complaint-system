<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Complaint Management Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: {
                                50: "#eff6ff",
                                100: "#dbeafe",
                                200: "#bfdbfe",
                                300: "#93c5fd",
                                400: "#60a5fa",
                                500: "#3b82f6",
                                600: "#2563eb",
                                700: "#1d4ed8",
                                800: "#1e40af",
                                900: "#1e3a8a",
                            },
                        },
                    },
                },
            };
        </script>
    </head>
    <body class="bg-gray-50 min-h-screen">
        <!-- Navigation Header -->
        <nav class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo and Title -->
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <div
                                class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center mr-3"
                            >
                                <svg
                                    class="w-5 h-5 text-white"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                    ></path>
                                </svg>
                            </div>
                            <h1 class="text-xl font-semibold text-gray-900">
                                Complaint Management
                            </h1>
                        </div>
                    </div>

                    <!-- User Menu -->
                    <div class="flex items-center space-x-4">
                        <span
                            id="userInfo"
                            class="text-sm text-gray-600"
                        ></span>
                        <button
                            id="logoutButton"
                            class="text-sm text-gray-500 hover:text-gray-700 transition-colors duration-200"
                        >
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Page Header -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">
                    Complaints Dashboard
                </h2>
                <p class="text-gray-600">
                    Manage and track complaint statuses and assignments
                </p>
            </div>

            <!-- Filters and Controls -->
            <div
                class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6"
            >
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <!-- Status Filter -->
                    <div>
                        <label
                            for="statusFilter"
                            class="block text-sm font-medium text-gray-700 mb-2"
                            >Status</label
                        >
                        <select
                            id="statusFilter"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        >
                            <option value="">All Statuses</option>
                            <option value="reported">Reported</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>

                    <!-- Hostel Filter -->
                    <div>
                        <label
                            for="hostelFilter"
                            class="block text-sm font-medium text-gray-700 mb-2"
                            >Hostel</label
                        >
                        <select
                            id="hostelFilter"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        >
                            <option value="">All Hostels</option>
                        </select>
                    </div>

                    <!-- Category Filter -->
                    <div>
                        <label
                            for="categoryFilter"
                            class="block text-sm font-medium text-gray-700 mb-2"
                            >Category</label
                        >
                        <select
                            id="categoryFilter"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        >
                            <option value="">All Categories</option>
                        </select>
                    </div>

                    <!-- Severity Filter -->
                    <div>
                        <label
                            for="severityFilter"
                            class="block text-sm font-medium text-gray-700 mb-2"
                            >Severity</label
                        >
                        <select
                            id="severityFilter"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        >
                            <option value="">All Severities</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-between items-center">
                    <div class="flex space-x-3">
                        <button
                            id="refreshButton"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors duration-200"
                        >
                            <svg
                                class="w-4 h-4 mr-2"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                ></path>
                            </svg>
                            Refresh
                        </button>
                    </div>

                    <div class="text-sm text-gray-500">
                        <span id="totalCount">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Complaints Table -->
            <div
                class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"
            >
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="id"
                                >
                                    ID
                                    <svg
                                        class="inline w-4 h-4 ml-1"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"
                                        ></path>
                                    </svg>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="hostel"
                                >
                                    Hostel
                                    <svg
                                        class="inline w-4 h-4 ml-1"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"
                                        ></path>
                                    </svg>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="category"
                                >
                                    Category
                                    <svg
                                        class="inline w-4 h-4 ml-1"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"
                                        ></path>
                                    </svg>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="severity"
                                >
                                    Severity
                                    <svg
                                        class="inline w-4 h-4 ml-1"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"
                                        ></path>
                                    </svg>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="status"
                                >
                                    Status
                                    <svg
                                        class="inline w-4 h-4 ml-1"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"
                                        ></path>
                                    </svg>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="created_at"
                                >
                                    Created
                                    <svg
                                        class="inline w-4 h-4 ml-1"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"
                                        ></path>
                                    </svg>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody
                            id="complaintsTableBody"
                            class="bg-white divide-y divide-gray-200"
                        >
                            <!-- Loading State -->
                            <tr id="loadingRow">
                                <td colspan="7" class="px-6 py-12 text-center">
                                    <div
                                        class="flex items-center justify-center"
                                    >
                                        <svg
                                            class="animate-spin -ml-1 mr-3 h-8 w-8 text-primary-600"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                        >
                                            <circle
                                                class="opacity-25"
                                                cx="12"
                                                cy="12"
                                                r="10"
                                                stroke="currentColor"
                                                stroke-width="4"
                                            ></circle>
                                            <path
                                                class="opacity-75"
                                                fill="currentColor"
                                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                            ></path>
                                        </svg>
                                        <span class="text-gray-500"
                                            >Loading complaints...</span
                                        >
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div
                    id="pagination"
                    class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6"
                >
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button
                            id="prevPageMobile"
                            class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                        >
                            Previous
                        </button>
                        <button
                            id="nextPageMobile"
                            class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                        >
                            Next
                        </button>
                    </div>
                    <div
                        class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between"
                    >
                        <div>
                            <p
                                id="paginationInfo"
                                class="text-sm text-gray-700"
                            >
                                Showing <span id="showingStart">0</span> to
                                <span id="showingEnd">0</span> of
                                <span id="showingTotal">0</span> results
                            </p>
                        </div>
                        <div>
                            <nav
                                class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px"
                                aria-label="Pagination"
                            >
                                <button
                                    id="prevPage"
                                    class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                                >
                                    <span class="sr-only">Previous</span>
                                    <svg
                                        class="h-5 w-5"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M15 19l-7-7 7-7"
                                        ></path>
                                    </svg>
                                </button>
                                <div id="pageNumbers" class="flex">
                                    <!-- Page numbers will be inserted here -->
                                </div>
                                <button
                                    id="nextPage"
                                    class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                                >
                                    <span class="sr-only">Next</span>
                                    <svg
                                        class="h-5 w-5"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 5l7 7-7 7"
                                        ></path>
                                    </svg>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complaint Detail Modal -->
        <div
            id="complaintModal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50"
        >
            <div
                class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white"
            >
                <div class="mt-3">
                    <!-- Modal Header -->
                    <div
                        class="flex items-center justify-between pb-4 border-b border-gray-200"
                    >
                        <h3 class="text-lg font-medium text-gray-900">
                            Complaint Details
                        </h3>
                        <button
                            id="closeModal"
                            class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
                        >
                            <svg
                                class="w-6 h-6"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"
                                ></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Modal Content -->
                    <div id="modalContent" class="mt-6">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <script>
            // API Configuration
            const API_BASE_URL = window.location.origin;

            // State Management
            let currentPage = 1;
            let pageSize = 20;
            let currentSort = "created_at";
            let sortDirection = "desc";
            let currentFilters = {};
            let complaints = [];
            let porters = [];

            // DOM Elements
            const complaintsTableBody = document.getElementById(
                "complaintsTableBody"
            );
            const loadingRow = document.getElementById("loadingRow");
            const totalCount = document.getElementById("totalCount");
            const refreshButton = document.getElementById("refreshButton");
            const complaintModal = document.getElementById("complaintModal");
            const modalContent = document.getElementById("modalContent");
            const closeModal = document.getElementById("closeModal");
            const logoutButton = document.getElementById("logoutButton");
            const userInfo = document.getElementById("userInfo");

            // Filter Elements
            const statusFilter = document.getElementById("statusFilter");
            const hostelFilter = document.getElementById("hostelFilter");
            const categoryFilter = document.getElementById("categoryFilter");
            const severityFilter = document.getElementById("severityFilter");

            // Pagination Elements
            const prevPage = document.getElementById("prevPage");
            const nextPage = document.getElementById("nextPage");
            const prevPageMobile = document.getElementById("prevPageMobile");
            const nextPageMobile = document.getElementById("nextPageMobile");
            const pageNumbers = document.getElementById("pageNumbers");
            const paginationInfo = document.getElementById("paginationInfo");
            const showingStart = document.getElementById("showingStart");
            const showingEnd = document.getElementById("showingEnd");
            const showingTotal = document.getElementById("showingTotal");

            // Utility Functions
            function getAuthHeaders() {
                const token = sessionStorage.getItem("access_token");
                const headers = {};
                if (token) headers["Authorization"] = `Bearer ${token}`;
                return headers;
            }

            // Helper to perform fetch calls with Authorization when available.
            // Ensures Content-Type is set only for requests with a body to avoid
            // triggering browser auth popups on 401 responses to GET requests.
            async function fetchWithAuth(url, options = {}) {
                options.headers = options.headers || {};

                // Merge auth headers without overwriting provided headers
                const authHeaders = getAuthHeaders();
                for (const k in authHeaders) {
                    if (!(k in options.headers))
                        options.headers[k] = authHeaders[k];
                }

                // If there is a body and Content-Type isn't set, assume JSON
                if (options.body) {
                    const normalized = {};
                    Object.keys(options.headers || {}).forEach(
                        (k) =>
                            (normalized[k.toLowerCase()] = options.headers[k])
                    );
                    if (!("content-type" in normalized)) {
                        options.headers["Content-Type"] = "application/json";
                    }
                }

                return fetch(url, options);
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                return (
                    date.toLocaleDateString() + " " + date.toLocaleTimeString()
                );
            }

            function getStatusBadge(status) {
                const statusClasses = {
                    reported: "bg-yellow-100 text-yellow-800",
                    in_progress: "bg-blue-100 text-blue-800",
                    resolved: "bg-green-100 text-green-800",
                    closed: "bg-gray-100 text-gray-800",
                };
                return statusClasses[status] || "bg-gray-100 text-gray-800";
            }

            function getSeverityBadge(severity) {
                const severityClasses = {
                    low: "bg-green-100 text-green-800",
                    medium: "bg-yellow-100 text-yellow-800",
                    high: "bg-orange-100 text-orange-800",
                    critical: "bg-red-100 text-red-800",
                };
                return severityClasses[severity] || "bg-gray-100 text-gray-800";
            }

            // API Functions
            async function fetchComplaints() {
                try {
                    const params = new URLSearchParams({
                        page: currentPage,
                        page_size: pageSize,
                        ...currentFilters,
                    });

                    const response = await fetchWithAuth(
                        `${API_BASE_URL}/api/v1/complaints?${params}`
                    );

                    if (!response.ok) {
                        if (response.status === 401) {
                            // Token expired, redirect to login
                            sessionStorage.clear();
                            window.location.href = "/dashboard/login.html";
                            return;
                        }
                        throw new Error("Failed to fetch complaints");
                    }

                    const data = await response.json();
                    complaints = data.items;
                    updateComplaintsTable(data);
                    updatePagination(data);
                } catch (error) {
                    console.error("Error fetching complaints:", error);
                    showError("Failed to load complaints. Please try again.");
                }
            }

            async function fetchPorters() {
                try {
                    const response = await fetchWithAuth(
                        `${API_BASE_URL}/api/v1/porters`
                    );

                    if (response.ok) {
                        porters = await response.json();
                    }
                } catch (error) {
                    console.error("Error fetching porters:", error);
                }
            }

            async function fetchComplaintDetails(complaintId) {
                try {
                    const response = await fetchWithAuth(
                        `${API_BASE_URL}/api/v1/complaints/${complaintId}`
                    );

                    if (!response.ok) {
                        throw new Error("Failed to fetch complaint details");
                    }

                    return await response.json();
                } catch (error) {
                    console.error("Error fetching complaint details:", error);
                    throw error;
                }
            }

            async function updateComplaint(complaintId, updates) {
                try {
                    const response = await fetchWithAuth(
                        `${API_BASE_URL}/api/v1/complaints/${complaintId}`,
                        {
                            method: "PATCH",
                            body: JSON.stringify(updates),
                        }
                    );

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(
                            errorData.detail || "Failed to update complaint"
                        );
                    }

                    return await response.json();
                } catch (error) {
                    console.error("Error updating complaint:", error);
                    throw error;
                }
            }

            // UI Update Functions
            function updateComplaintsTable(data) {
                loadingRow.style.display = "none";

                if (data.items.length === 0) {
                    complaintsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            No complaints found matching your criteria.
                        </td>
                    </tr>
                `;
                    return;
                }

                complaintsTableBody.innerHTML = data.items
                    .map(
                        (complaint) => `
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="openComplaintModal('${
                    complaint.id
                }')">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${complaint.id.substring(0, 8)}...
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${complaint.hostel}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${complaint.category}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getSeverityBadge(
                            complaint.severity
                        )}">
                            ${complaint.severity}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadge(
                            complaint.status
                        )}">
                            ${complaint.status.replace("_", " ")}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatDate(complaint.created_at)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-primary-600 hover:text-primary-900 transition-colors duration-200">
                            View Details
                        </button>
                    </td>
                </tr>
            `
                    )
                    .join("");
            }

            function updatePagination(data) {
                const start = (data.page - 1) * data.page_size + 1;
                const end = Math.min(data.page * data.page_size, data.total);

                showingStart.textContent = start;
                showingEnd.textContent = end;
                showingTotal.textContent = data.total;
                totalCount.textContent = `${data.total} complaints`;

                // Update pagination buttons
                prevPage.disabled = data.page === 1;
                nextPage.disabled = data.page === data.total_pages;
                prevPageMobile.disabled = data.page === 1;
                nextPageMobile.disabled = data.page === data.total_pages;

                // Generate page numbers
                const maxVisiblePages = 5;
                let startPage = Math.max(
                    1,
                    data.page - Math.floor(maxVisiblePages / 2)
                );
                let endPage = Math.min(
                    data.total_pages,
                    startPage + maxVisiblePages - 1
                );

                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                pageNumbers.innerHTML = "";
                for (let i = startPage; i <= endPage; i++) {
                    const pageButton = document.createElement("button");
                    pageButton.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                        i === data.page
                            ? "z-10 bg-primary-50 border-primary-500 text-primary-600"
                            : "bg-white border-gray-300 text-gray-500 hover:bg-gray-50"
                    }`;
                    pageButton.textContent = i;
                    pageButton.onclick = () => {
                        currentPage = i;
                        fetchComplaints();
                    };
                    pageNumbers.appendChild(pageButton);
                }
            }

            function updateFilters() {
                currentFilters = {};
                if (statusFilter.value)
                    currentFilters.status = statusFilter.value;
                if (hostelFilter.value)
                    currentFilters.hostel = hostelFilter.value;
                if (categoryFilter.value)
                    currentFilters.category = categoryFilter.value;
                if (severityFilter.value)
                    currentFilters.severity = severityFilter.value;

                currentPage = 1;
                fetchComplaints();
            }

            // Modal Functions
            async function openComplaintModal(complaintId) {
                try {
                    const complaint = await fetchComplaintDetails(complaintId);
                    showComplaintModal(complaint);
                } catch (error) {
                    showError("Failed to load complaint details");
                }
            }

            function showComplaintModal(complaint) {
                modalContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column - Complaint Details -->
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-4">Complaint Information</h4>
                            <dl class="grid grid-cols-1 gap-4">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">ID</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${
                                        complaint.id
                                    }</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Hostel</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${
                                        complaint.hostel
                                    }</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Wing</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${
                                        complaint.wing || "N/A"
                                    }</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Room Number</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${
                                        complaint.room_number
                                    }</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Category</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${
                                        complaint.category
                                    }</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Severity</dt>
                                    <dd class="mt-1">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getSeverityBadge(
                                            complaint.severity
                                        )}">
                                            ${complaint.severity}
                                        </span>
                                    </dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Status</dt>
                                    <dd class="mt-1">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadge(
                                            complaint.status
                                        )}">
                                            ${complaint.status.replace(
                                                "_",
                                                " "
                                            )}
                                        </span>
                                    </dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Created</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${formatDate(
                                        complaint.created_at
                                    )}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Updated</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${
                                        complaint.updated_at
                                            ? formatDate(complaint.updated_at)
                                            : "Never"
                                    }</dd>
                                </div>
                            </dl>
                        </div>

                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-4">Description</h4>
                            <p class="text-sm text-gray-700 bg-gray-50 p-4 rounded-lg">${
                                complaint.description
                            }</p>
                        </div>

                        ${
                            complaint.photo_urls &&
                            complaint.photo_urls.length > 0
                                ? `
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-4">Photos</h4>
                            <div class="grid grid-cols-2 gap-4">
                                ${complaint.photo_urls
                                    .map(
                                        (url) => `
                                    <img src="${url}" alt="Complaint photo" class="w-full h-32 object-cover rounded-lg border border-gray-200">
                                `
                                    )
                                    .join("")}
                            </div>
                        </div>
                        `
                                : ""
                        }
                    </div>

                    <!-- Right Column - Actions -->
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-4">Actions</h4>
                            
                            <!-- Status Update -->
                            <div class="mb-6">
                                <label for="statusSelect" class="block text-sm font-medium text-gray-700 mb-2">Update Status</label>
                                <select id="statusSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <option value="reported" ${
                                        complaint.status === "reported"
                                            ? "selected"
                                            : ""
                                    }>Reported</option>
                                    <option value="in_progress" ${
                                        complaint.status === "in_progress"
                                            ? "selected"
                                            : ""
                                    }>In Progress</option>
                                    <option value="resolved" ${
                                        complaint.status === "resolved"
                                            ? "selected"
                                            : ""
                                    }>Resolved</option>
                                    <option value="closed" ${
                                        complaint.status === "closed"
                                            ? "selected"
                                            : ""
                                    }>Closed</option>
                                </select>
                            </div>

                            <!-- Assignment -->
                            <div class="mb-6">
                                <label for="porterSelect" class="block text-sm font-medium text-gray-700 mb-2">Assign Porter</label>
                                <select id="porterSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Unassigned</option>
                                    ${porters
                                        .map(
                                            (porter) => `
                                        <option value="${porter.id}" ${
                                                complaint.assigned_porter_id ===
                                                porter.id
                                                    ? "selected"
                                                    : ""
                                            }>
                                            ${porter.full_name} (${
                                                porter.email || porter.phone
                                            })
                                        </option>
                                    `
                                        )
                                        .join("")}
                                </select>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex space-x-3">
                                <button id="updateComplaint" class="flex-1 bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors duration-200">
                                    Update Complaint
                                </button>
                                <button id="assignToMe" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors duration-200">
                                    Assign to Me
                                </button>
                            </div>
                        </div>

                        <!-- Current Assignment -->
                        ${
                            complaint.assigned_porter_id
                                ? `
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-4">Current Assignment</h4>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-sm text-gray-700">
                                    Assigned to: ${
                                        porters.find(
                                            (p) =>
                                                p.id ===
                                                complaint.assigned_porter_id
                                        )?.full_name || "Unknown Porter"
                                    }
                                </p>
                            </div>
                        </div>
                        `
                                : ""
                        }
                    </div>
                </div>
            `;

                // Add event listeners for modal actions
                document.getElementById("updateComplaint").onclick = () =>
                    updateComplaintFromModal(complaint.id);
                document.getElementById("assignToMe").onclick = () =>
                    assignToMe(complaint.id);

                complaintModal.classList.remove("hidden");
            }

            async function updateComplaintFromModal(complaintId) {
                const status = document.getElementById("statusSelect").value;
                const porterId = document.getElementById("porterSelect").value;

                const updates = {};
                if (status) updates.status = status;
                if (porterId) updates.assigned_porter_id = porterId;

                try {
                    await updateComplaint(complaintId, updates);
                    complaintModal.classList.add("hidden");
                    fetchComplaints(); // Refresh the list
                    showSuccess("Complaint updated successfully");
                } catch (error) {
                    showError(error.message);
                }
            }

            async function assignToMe(complaintId) {
                const userId = sessionStorage.getItem("user_id");
                if (!userId) {
                    showError("User ID not found");
                    return;
                }

                try {
                    await updateComplaint(complaintId, {
                        assigned_porter_id: userId,
                    });
                    complaintModal.classList.add("hidden");
                    fetchComplaints(); // Refresh the list
                    showSuccess("Complaint assigned to you");
                } catch (error) {
                    showError(error.message);
                }
            }

            function showError(message) {
                // Simple error notification - could be enhanced with a proper toast system
                alert("Error: " + message);
            }

            function showSuccess(message) {
                // Simple success notification - could be enhanced with a proper toast system
                alert("Success: " + message);
            }

            // Event Listeners
            refreshButton.onclick = () => {
                currentPage = 1;
                fetchComplaints();
            };

            closeModal.onclick = () => {
                complaintModal.classList.add("hidden");
            };

            logoutButton.onclick = () => {
                sessionStorage.clear();
                window.location.href = "/dashboard/login.html";
            };

            // Filter event listeners
            [
                statusFilter,
                hostelFilter,
                categoryFilter,
                severityFilter,
            ].forEach((filter) => {
                filter.onchange = updateFilters;
            });

            // Pagination event listeners
            prevPage.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    fetchComplaints();
                }
            };

            nextPage.onclick = () => {
                currentPage++;
                fetchComplaints();
            };

            prevPageMobile.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    fetchComplaints();
                }
            };

            nextPageMobile.onclick = () => {
                currentPage++;
                fetchComplaints();
            };

            // Initialize
            document.addEventListener("DOMContentLoaded", async () => {
                // Check authentication
                if (!sessionStorage.getItem("access_token")) {
                    window.location.href = "/dashboard/login.html";
                    return;
                }

                // Set user info
                const userId = sessionStorage.getItem("user_id");
                userInfo.textContent = `User ID: ${userId}`;

                // Load initial data
                await fetchPorters();
                await fetchComplaints();

                // Populate filter options
                // This would ideally come from the API, but for now we'll use common values
                const hostels = [
                    "Hostel A",
                    "Hostel B",
                    "Hostel C",
                    "Hostel D",
                ];
                const categories = [
                    "Plumbing",
                    "Electrical",
                    "Cleaning",
                    "Maintenance",
                    "Security",
                ];

                hostels.forEach((hostel) => {
                    const option = document.createElement("option");
                    option.value = hostel;
                    option.textContent = hostel;
                    hostelFilter.appendChild(option);
                });

                categories.forEach((category) => {
                    const option = document.createElement("option");
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
            });
        </script>
    </body>
</html>
