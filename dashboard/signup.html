<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin Signup - Complaint Management System</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: {
                                50: "#eff6ff",
                                100: "#dbeafe",
                                200: "#bfdbfe",
                                300: "#93c5fd",
                                400: "#60a5fa",
                                500: "#3b82f6",
                                600: "#2563eb",
                                700: "#1d4ed8",
                                800: "#1e40af",
                                900: "#1e3a8a",
                            },
                        },
                    },
                },
            };
        </script>
    </head>
    <body
        class="min-h-screen bg-gradient-to-br from-primary-50 to-primary-100 flex items-center justify-center p-4"
    >
        <div class="max-w-md w-full">
            <!-- Logo/Header -->
            <div class="text-center mb-8">
                <div
                    class="inline-flex items-center justify-center w-16 h-16 bg-primary-600 rounded-full mb-4"
                >
                    <svg
                        class="w-8 h-8 text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"
                        ></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    Admin Registration
                </h1>
                <p class="text-gray-600">Complete your admin account setup</p>
            </div>

            <!-- Signup Card -->
            <div
                class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100"
            >
                <form id="signupForm" class="space-y-6">
                    <!-- Email Field (read-only, from invitation) -->
                    <div>
                        <label
                            for="email"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Email Address
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            readonly
                            class="block w-full px-3 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed"
                        />
                    </div>

                    <!-- Full Name Field -->
                    <div>
                        <label
                            for="fullName"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Full Name
                        </label>
                        <input
                            type="text"
                            id="fullName"
                            name="fullName"
                            required
                            class="block w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
                            placeholder="Enter your full name"
                        />
                    </div>

                    <!-- Password Field -->
                    <div>
                        <label
                            for="password"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Password
                        </label>
                        <input
                            type="password"
                            id="password"
                            name="password"
                            required
                            class="block w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
                            placeholder="Enter your password"
                        />
                        <p class="mt-1 text-xs text-gray-500">
                            Password must be at least 8 characters with uppercase, lowercase, and a number
                        </p>
                    </div>

                    <!-- OTP Field -->
                    <div id="otpSection" class="hidden">
                        <label
                            for="otpCode"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Verification Code
                        </label>
                        <div class="flex gap-2">
                            <input
                                type="text"
                                id="otpCode"
                                name="otpCode"
                                maxlength="6"
                                class="block flex-1 px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
                                placeholder="Enter 6-digit code"
                            />
                            <button
                                type="button"
                                id="sendOtpButton"
                                class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
                            >
                                Send Code
                            </button>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">
                            We'll send a verification code to your email
                        </p>
                    </div>

                    <!-- Error Message -->
                    <div
                        id="errorMessage"
                        class="hidden bg-red-50 border border-red-200 rounded-lg p-4"
                    >
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg
                                    class="h-5 w-5 text-red-400"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                    ></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p
                                    id="errorText"
                                    class="text-sm text-red-800"
                                ></p>
                            </div>
                        </div>
                    </div>

                    <!-- Success Message -->
                    <div
                        id="successMessage"
                        class="hidden bg-green-50 border border-green-200 rounded-lg p-4"
                    >
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg
                                    class="h-5 w-5 text-green-400"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                    ></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p
                                    id="successText"
                                    class="text-sm text-green-800"
                                ></p>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button
                        type="submit"
                        id="signupButton"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span id="signupButtonText">Create Account</span>
                        <svg
                            id="signupSpinner"
                            class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <circle
                                class="opacity-25"
                                cx="12"
                                cy="12"
                                r="10"
                                stroke="currentColor"
                                stroke-width="4"
                            ></circle>
                            <path
                                class="opacity-75"
                                fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                            ></path>
                        </svg>
                    </button>
                </form>
            </div>

            <!-- Footer -->
            <div class="text-center mt-8">
                <p class="text-sm text-gray-500">
                    Already have an account?
                    <a href="/dashboard/login.html" class="text-primary-600 hover:text-primary-700 font-medium">
                        Sign in
                    </a>
                </p>
            </div>
        </div>

        <script>
            // API Configuration
            const API_BASE_URL = window.location.origin;

            // Get invitation token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const invitationToken = urlParams.get("token");

            // DOM Elements
            const signupForm = document.getElementById("signupForm");
            const emailInput = document.getElementById("email");
            const fullNameInput = document.getElementById("fullName");
            const passwordInput = document.getElementById("password");
            const otpCodeInput = document.getElementById("otpCode");
            const otpSection = document.getElementById("otpSection");
            const sendOtpButton = document.getElementById("sendOtpButton");
            const signupButton = document.getElementById("signupButton");
            const signupButtonText = document.getElementById("signupButtonText");
            const signupSpinner = document.getElementById("signupSpinner");
            const errorMessage = document.getElementById("errorMessage");
            const errorText = document.getElementById("errorText");
            const successMessage = document.getElementById("successMessage");
            const successText = document.getElementById("successText");

            let verifiedOtp = false;

            // Utility Functions
            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove("hidden");
                successMessage.classList.add("hidden");
            }

            function showSuccess(message) {
                successText.textContent = message;
                successMessage.classList.remove("hidden");
                errorMessage.classList.add("hidden");
            }

            function hideMessages() {
                errorMessage.classList.add("hidden");
                successMessage.classList.add("hidden");
            }

            function setLoading(loading) {
                if (loading) {
                    signupButton.disabled = true;
                    signupButtonText.classList.add("hidden");
                    signupSpinner.classList.remove("hidden");
                } else {
                    signupButton.disabled = false;
                    signupButtonText.classList.remove("hidden");
                    signupSpinner.classList.add("hidden");
                }
            }

            // Validate invitation token on page load
            async function validateInvitation() {
                if (!invitationToken) {
                    showError("Invalid invitation link. Please contact your administrator.");
                    signupForm.style.display = "none";
                    return false;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/auth/invitation/${invitationToken}`);
                    
                    if (!response.ok) {
                        showError("Invalid or expired invitation link. Please contact your administrator.");
                        signupForm.style.display = "none";
                        return false;
                    }

                    const data = await response.json();
                    emailInput.value = data.email;
                    otpSection.classList.remove("hidden");
                    return true;
                } catch (error) {
                    console.error("Invitation validation error:", error);
                    showError("Failed to validate invitation. Please try again.");
                    signupForm.style.display = "none";
                    return false;
                }
            }

            // Send OTP
            async function sendOTP() {
                const email = emailInput.value.trim();

                if (!email) {
                    showError("Email is required");
                    return;
                }

                try {
                    setLoading(true);
                    hideMessages();

                    const response = await fetch(`${API_BASE_URL}/auth/send-otp`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            email: email,
                            purpose: "signup",
                        }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showSuccess("Verification code sent to your email!");
                    } else {
                        showError(data.detail || "Failed to send verification code");
                    }
                } catch (error) {
                    console.error("Send OTP error:", error);
                    showError("An error occurred. Please try again.");
                } finally {
                    setLoading(false);
                }
            }

            // Verify OTP
            async function verifyOTP() {
                const email = emailInput.value.trim();
                const otpCode = otpCodeInput.value.trim();

                if (!otpCode || otpCode.length !== 6) {
                    showError("Please enter a valid 6-digit verification code");
                    return false;
                }

                try {
                    hideMessages();

                    const response = await fetch(`${API_BASE_URL}/auth/verify-otp`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            email: email,
                            otp_code: otpCode,
                            purpose: "signup",
                        }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        verifiedOtp = true;
                        showSuccess("Email verified successfully!");
                        return true;
                    } else {
                        showError(data.detail || "Invalid verification code");
                        return false;
                    }
                } catch (error) {
                    console.error("Verify OTP error:", error);
                    showError("An error occurred. Please try again.");
                    return false;
                }
            }

            // Signup
            async function signup() {
                const email = emailInput.value.trim();
                const fullName = fullNameInput.value.trim();
                const password = passwordInput.value;

                if (!fullName || !password) {
                    showError("Please fill in all required fields");
                    return;
                }

                if (!verifiedOtp) {
                    showError("Please verify your email with the OTP code first");
                    return;
                }

                try {
                    setLoading(true);
                    hideMessages();

                    const response = await fetch(`${API_BASE_URL}/auth/signup`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            invitation_token: invitationToken,
                            full_name: fullName,
                            password: password,
                        }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showSuccess("Account created successfully! Redirecting to login...");
                        setTimeout(() => {
                            window.location.href = "/dashboard/login.html";
                        }, 2000);
                    } else {
                        showError(data.detail || "Failed to create account");
                    }
                } catch (error) {
                    console.error("Signup error:", error);
                    showError("An error occurred. Please try again.");
                } finally {
                    setLoading(false);
                }
            }

            // Event Listeners
            sendOtpButton.addEventListener("click", sendOTP);

            signupForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                
                // If OTP is provided but not verified, verify it first
                if (otpCodeInput.value && !verifiedOtp) {
                    const verified = await verifyOTP();
                    if (!verified) {
                        return;
                    }
                } else if (!verifiedOtp) {
                    showError("Please verify your email with the OTP code first");
                    return;
                }

                // If OTP is verified, proceed with signup
                await signup();
            });

            // Clear messages when user starts typing
            [fullNameInput, passwordInput, otpCodeInput].forEach((input) => {
                input.addEventListener("input", hideMessages);
            });

            // Validate invitation on page load
            validateInvitation();
        </script>
    </body>
</html>

